<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Books â€” Library</title>
  <link rel="stylesheet" href="style.css">
  <link rel="icon" href="favicon.svg">
</head>

<script src="firebase-config.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<script>
  firebase.initializeApp(window.FIREBASE_CONFIG);
  const auth = firebase.auth();
  const db = firebase.firestore();
</script>

<body class="dashboard">
<div class="container">

  <!-- BACK BUTTON FIXED -->
  <a class="logo" href="dashboard.html">ðŸ“š</a>
  <button class="dash-btn back" style="position:fixed;top:16px;left:16px;z-index:1000;" onclick="location.href='dashboard.html'">â¬… Back</button>

  <!-- VIEW MY BOOKS BUTTON INSIDE FRAME -->
  <div class="center-actions" style="margin-top:60px;">
    <button class="dash-btn primary" onclick="location.href='mybooks.html'">ðŸ“– View My Books</button>
  </div>

  <div class="hero card" style="margin-top:16px;">
    <h2>Search Books ðŸ“š</h2>
    <p class="muted">Reserve available copies</p>
  </div>

  <div class="card">
    <input id="search" class="search" placeholder="Search books...">
  </div>

  <div id="bookList" class="books-grid"></div>

</div>

<script>
let books = [];
let userReservedBooks = new Set();


auth.onAuthStateChanged(async user => {
  if (!user) {
    location.href = "index.html";
    return;
  }

  const userRef = db.collection("users").doc(user.uid);
  const snap = await userRef.get();

  if (!snap.exists) {
    await userRef.set({
      email: user.email,
      sid: "TEMP-" + user.uid.slice(0, 6),
      createdAt: firebase.firestore.FieldValue.serverTimestamp()
    });
  }

  // reservations listener
  db.collection("reservations")
    .where("userId", "==", user.uid)
    .where("status", "==", "Active")
    .onSnapshot(snapshot => {
      userReservedBooks.clear();
      snapshot.forEach(doc => userReservedBooks.add(doc.data().bookId));
      renderBooks(books);
    });
});

db.collection("books").onSnapshot(snapshot => {
  books = [];
  snapshot.forEach(doc => books.push({ id: doc.id, ...doc.data() }));
  renderBooks(books);
});

function renderBooks(list) {
  const el = document.getElementById("bookList");
  el.innerHTML = "";
  list.forEach(book => {
    const alreadyReserved = userReservedBooks.has(book.id);
    const available = book.availableCopies > 0;
    el.innerHTML += `
      <div class="card book-card">
        <h4>${book.name}</h4>
        <p class="muted">by ${book.author}</p>
        <p>Status: <b>${available ? `Available (${book.availableCopies})` : 'Unavailable'}</b></p>
        ${alreadyReserved
          ? `<button class="dash-btn secondary" disabled>Already Reserved</button>`
          : available
            ? `<button class="dash-btn primary" onclick="reserveBook(this,'${book.id}','${book.name}')">Reserve</button>`
            : `<button class="dash-btn secondary" disabled>Unavailable</button>`}
      </div>
    `;
  });
}

document.getElementById("search").addEventListener("input", e => {
  const q = e.target.value.toLowerCase();
  renderBooks(books.filter(b => b.name.toLowerCase().includes(q) || b.author.toLowerCase().includes(q)));
});

async function reserveBook(btn, bookId, bookName) {
  const user = auth.currentUser;
  btn.disabled = true;

  try {
    const activeSnap = await db.collection("reservations")
      .where("userId", "==", user.uid)
      .where("status", "==", "Active")
      .get();

    if (activeSnap.size >= 5) { alert("You can reserve only 5 books"); btn.disabled = false; return; }

    const sameBook = await db.collection("reservations")
      .where("userId", "==", user.uid)
      .where("bookId", "==", bookId)
      .where("status", "==", "Active")
      .get();

    if (!sameBook.empty) { alert("You already reserved this book"); btn.disabled = false; return; }

    const userDoc = await db.collection("users").doc(user.uid).get();

    if (!userDoc.exists || !userDoc.data().sid) {
  alert("Complete your profile before reserving books");
  btn.disabled = false;
  return;
}

    const studentId = userDoc.data().sid;
    const bookRef = db.collection("books").doc(bookId);

    await db.runTransaction(async tx => {
      const snap = await tx.get(bookRef);
      if (!snap.exists) throw new Error("Book not found");
      const data = snap.data();
      if (data.availableCopies <= 0) throw new Error("No copies left");

      tx.update(bookRef, { availableCopies: data.availableCopies - 1 });
      const now = firebase.firestore.Timestamp.now();
      const dueAt = firebase.firestore.Timestamp.fromDate(new Date(now.toDate().getTime() + 10*24*60*60*1000));

      tx.set(db.collection("reservations").doc(), {
        bookId, bookName, userId: user.uid, studentId,
        status: "Active", reservedAt: now, dueAt, renewCount: 0
      });
        });
            alert("Book reserved successfully");
  } catch (err) { alert(err.message); btn.disabled = false; }
}
</script>
</body>
</html>
