<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" href="style.css">
</head>

<script src="firebase-config.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<script>
  firebase.initializeApp(window.FIREBASE_CONFIG);
  const auth = firebase.auth();
  const db = firebase.firestore();
</script>

<body class="dashboard">
<div class="container">

  <!-- BACK BUTTON FIXED -->
  <button class="dash-btn back" style="position:fixed;top:16px;left:16px;z-index:1000;" onclick="location.href='index.html'">‚¨Ö Back</button>

  <!-- HERO -->
  <div class="hero card" style="margin-top:60px;">
    <h2>Welcome back üëã</h2>
    <p class="muted">Your library summary</p>
  </div>

  <!-- STATS -->
  <div class="stat-box">
    <div class="stat card">
      <h3 id="borrowedCount">0</h3>
      <p>Borrowed</p>
    </div>
    <div class="stat card">
      <h3 id="dueSoonCount">0</h3>
      <p>Due Soon</p>
    </div>
    <div class="stat card">
      <h3 id="feeCount">0</h3>
      <p>With Fee</p>
    </div>
  </div>

  <!-- DASHBOARD BUTTONS -->
  <div class="card center-actions" style="flex-direction:column; gap:10px;">
    <button class="dash-btn primary" id="searchBooksBtn">üîç Search Books</button>
    <button class="dash-btn secondary" id="myBooksBtn">üìñ My Books</button>
    <button class="dash-btn primary" id="profileBtn">üë§ Profile</button>
  </div>

</div>

<script>
auth.onAuthStateChanged(async user => {
  if (!user) return location.href = "index.html";

  document.getElementById("searchBooksBtn").onclick = () => location.href = "books.html";
  document.getElementById("myBooksBtn").onclick = () => location.href = "mybooks.html";
  document.getElementById("profileBtn").onclick = () => location.href = "profile.html";

  const snap = await db.collection("reservations")
    .where("userId", "==", user.uid)
    .where("status", "==", "Active")
    .get();

  const now = new Date();
  let borrowed = snap.size, dueSoon = 0, withFee = 0;

  snap.forEach(async doc => {
    const r = doc.data();
    if (!r.dueAt) return;
    const dueDate = r.dueAt.toDate();
    const daysLeft = (dueDate - now) / (1000 * 60 * 60 * 24);
    if (daysLeft <= 2 && daysLeft >= 0) dueSoon++;

    let fine = r.fineAmount || 0;
    let lastCalc = r.lastFineCalculatedAt ? r.lastFineCalculatedAt.toDate() : dueDate;

    if (now > dueDate) {
      const diffDays = Math.floor((now - lastCalc) / (1000 * 60 * 60 * 24));
      if (diffDays > 0) {
        fine += diffDays * 5;
        await db.collection("reservations").doc(doc.id).update({
          fineAmount: fine,
          lastFineCalculatedAt: firebase.firestore.Timestamp.fromDate(now)
        });
      }
      withFee++;
    }
  });

  document.getElementById("borrowedCount").innerText = borrowed;
  document.getElementById("dueSoonCount").innerText = dueSoon;
  document.getElementById("feeCount").innerText = withFee;
});
</script>
</body>
</html>
