<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>My Books</title>
  <link rel="stylesheet" href="style.css">
</head>

<script src="firebase-config.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<script>
  firebase.initializeApp(window.FIREBASE_CONFIG);
  const auth = firebase.auth();
  const db = firebase.firestore();
</script>

<body class="dashboard">

<div class="container">

  <div class="hero card">
    <h2>üìñ My Books</h2>
    <p class="muted">Borrowed books, renewals & fines</p>
  </div>

  <div id="myBooksList"></div>

  <div class="card center-actions">
    <button class="dash-btn back" onclick="location.href='dashboard.html'">‚¨Ö Back</button>
  </div>

</div>

<script>
auth.onAuthStateChanged(user => {
  if (!user) return location.href = "index.html";

  db.collection("reservations")
    .where("userId", "==", user.uid)
    .where("status", "==", "Active")
    .orderBy("reservedAt", "desc")
    .onSnapshot(async snapshot => {

      const el = document.getElementById("myBooksList");
      el.innerHTML = "";

      if (snapshot.empty) {
        el.innerHTML = "<p class='muted'>No active books</p>";
        return;
      }

      const now = new Date();

      for (const doc of snapshot.docs) {
        const r = doc.data();

        const dueDate = r.dueAt.toDate();
        const renewCount = r.renewCount || 0;

        let fine = r.fineAmount || 0;
        let finePaid = r.finePaid || false;
        let lastCalc = r.lastFineCalculatedAt
          ? r.lastFineCalculatedAt.toDate()
          : dueDate;

        // üí∞ PERSISTENT FINE CALCULATION
        if (now > dueDate && !finePaid) {
          const diffDays = Math.floor(
            (now - lastCalc) / (1000 * 60 * 60 * 24)
          );

          if (diffDays > 0) {
            fine += diffDays * 5;
            await db.collection("reservations").doc(doc.id).update({
              fineAmount: fine,
              lastFineCalculatedAt:
                firebase.firestore.Timestamp.fromDate(now)
            });
          }
        }

        const canRenew = renewCount < 3;
        const hasFine = fine > 0 && !finePaid;

        el.innerHTML += `
          <div class="card book-card">

            <h4>${r.bookName}</h4>

            <p><b>Due Date:</b> ${dueDate.toDateString()}</p>
            <p><b>Renewals:</b> ${renewCount} / 3</p>

            ${
              hasFine
                ? `<p style="color:#dc2626"><b>Fine:</b> ‚Çπ${fine}</p>`
                : `<p style="color:#16a34a"><b>No Fine</b></p>`
            }

            <div class="center-actions">

              <!-- üîÑ Renew -->
              <button class="dash-btn primary"
                ${canRenew ? "" : "disabled"}
                onclick="renewBook('${doc.id}')">
                üîÑ Renew (10 days)
              </button>

              <!-- üí≥ Pay Fine (shown whenever fine exists) -->
              ${
                hasFine
                  ? `<button class="dash-btn secondary"
                      onclick="payFine('${doc.id}')">
                      üí≥ Pay ‚Çπ${fine}
                    </button>`
                  : ""
              }

              <!-- ‚èé Return (ONLY if NO fine) -->
              ${
                !hasFine
                  ? `<button class="dash-btn back"
                      onclick="returnBook('${doc.id}','${r.bookId}')">
                      ‚èé Return
                    </button>`
                  : `<p style="color:#dc2626;font-size:14px">
                      Pay fine to return this book
                    </p>`
              }

            </div>
          </div>
        `;
      }
    });
});

// üîÑ Renew (fine stays)
async function renewBook(resId) {
  const now = new Date();
  const newDue = new Date(now);
  newDue.setDate(now.getDate() + 10);

  await db.collection("reservations").doc(resId).update({
    dueAt: firebase.firestore.Timestamp.fromDate(newDue),
    renewCount: firebase.firestore.FieldValue.increment(1)
  });

  alert("Renewed for 10 more days");
}

// üí≥ Pay Fine
async function payFine(resId) {
  await db.collection("reservations").doc(resId).update({
    finePaid: true,
    fineAmount: 0
  });

  alert("Fine paid successfully");
}

// ‚èé Return Book
async function returnBook(resId, bookId) {
  await db.collection("reservations").doc(resId).update({
    status: "Returned",
    returnedAt: firebase.firestore.FieldValue.serverTimestamp()
  });

  await db.collection("books").doc(bookId).update({
    availableCopies: firebase.firestore.FieldValue.increment(1)
  });

  alert("Book returned successfully");
}
</script>
</body>
</html>