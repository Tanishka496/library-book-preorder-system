<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>My Books</title>
  <link rel="stylesheet" href="style.css">
  <link rel="icon" href="favicon.svg">
</head>

<!-- Firebase -->
<script src="firebase-config.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<script>
  firebase.initializeApp(window.FIREBASE_CONFIG);
  const auth = firebase.auth();
  const db = firebase.firestore();
</script>

<body class="dashboard">
<div class="container">

  <!-- FIXED BACK BUTTON -->
  <button class="dash-btn back"
    style="position:fixed;top:16px;left:16px;z-index:1000"
    onclick="location.href='dashboard.html'">
    ‚¨Ö Back
  </button>

  <a class="logo" href="dashboard.html">üìö</a>
  <div class="hero card" style="margin-top:60px;">
    <h2>üìñ My Books</h2>
    <p class="muted">Borrowed books, renewals & fines</p>
  </div>

  <div id="myBooksList"></div>

</div>

<script>
/* ================= FIREBASE AUTH ================= */
auth.onAuthStateChanged(async user => {
  if (!user) return location.href = "index.html";

  // üî• Run fine calculation ONCE
  await calculateFinesOnce(user.uid);

  // üìñ Listen ONLY for UI updates
  listenMyBooks(user.uid);
});

/* ================= FINE CALCULATION (ONCE) ================= */
async function calculateFinesOnce(userId) {
  const snap = await db.collection("reservations")
    .where("userId", "==", userId)
    .where("status", "==", "Active")
    .get();

  const now = new Date();

  for (const doc of snap.docs) {
    const r = doc.data();

    if (r.finePaid) continue;

    const dueDate = r.dueAt.toDate();
    let lastCalc = r.lastFineCalculatedAt
      ? r.lastFineCalculatedAt.toDate()
      : dueDate;

    if (now <= lastCalc) continue;

    const diffDays = Math.floor(
      (now - lastCalc) / (1000 * 60 * 60 * 24)
    );

    if (diffDays > 0) {
      const newFine = (r.fineAmount || 0) + diffDays * 5;

      await db.collection("reservations").doc(doc.id).update({
        fineAmount: newFine,
        lastFineCalculatedAt:
          firebase.firestore.Timestamp.fromDate(now)
      });
    }
  }
}

/* ================= REALTIME UI LISTENER ================= */
function listenMyBooks(userId) {
  db.collection("reservations")
    .where("userId", "==", userId)
    .where("status", "==", "Active")
    .orderBy("reservedAt", "desc")
    .onSnapshot(snapshot => {

      const el = document.getElementById("myBooksList");
      el.innerHTML = "";

      if (snapshot.empty) {
        el.innerHTML = "<p class='muted'>No active books</p>";
        return;
      }

      snapshot.forEach(doc => {
        const r = doc.data();
        const dueDate = r.dueAt.toDate();
        const fine = r.fineAmount || 0;
        const renewCount = r.renewCount || 0;
        const hasFine = fine > 0 && !r.finePaid;

        el.innerHTML += `
          <div class="card book-card">
            <h4>${r.bookName}</h4>

            <p><b>Due Date:</b> ${dueDate.toDateString()}</p>
            <p><b>Renewals:</b> ${renewCount} / 3</p>

            ${
              hasFine
              ? `<p style="color:#dc2626"><b>Fine:</b> ‚Çπ${fine}</p>`
              : `<p style="color:#16a34a"><b>No Fine</b></p>`
            }

            <div class="center-actions">

              <button class="dash-btn primary"
                ${renewCount >= 3 ? "disabled" : ""}
                onclick="renewBook('${doc.id}')">
                üîÑ Renew (10 days)
              </button>

              ${
                hasFine
                  ? `<button class="dash-btn secondary"
                      onclick="payFine('${doc.id}','${r.bookId}')">
                      üí≥ Pay Fine
                    </button>`
                  : `<button class="dash-btn back"
                      onclick="returnBook('${doc.id}','${r.bookId}')">
                      ‚èé Return
                    </button>`
              }

              ${
                hasFine
                  ? `<p style="color:#dc2626;font-size:13px">
                      Pay fine to return this book
                    </p>`
                  : ""
              }

            </div>
          </div>
        `;
      });
    });
}

/* ================= RENEW BOOK ================= */
async function renewBook(resId) {
  const snap = await db.collection("reservations").doc(resId).get();
  const r = snap.data();

  const now = new Date();
  const newDue = new Date(r.dueAt.toDate());
  newDue.setDate(newDue.getDate() + 10);

  await db.collection("reservations").doc(resId).update({
    dueAt: firebase.firestore.Timestamp.fromDate(newDue),
    renewCount: firebase.firestore.FieldValue.increment(1)
  });

  alert("Renewed for 10 more days");
}

/* ================= PAY FINE (AUTO RETURN) ================= */
async function payFine(resId, bookId) {
  await db.collection("reservations").doc(resId).update({
    finePaid: true,
    fineAmount: 0,
    status: "Returned",
    returnedAt: firebase.firestore.FieldValue.serverTimestamp()
  });

  await db.collection("books").doc(bookId).update({
    availableCopies: firebase.firestore.FieldValue.increment(1)
  });

  alert("Fine paid and book returned");
}

/* ================= MANUAL RETURN ================= */
async function returnBook(resId, bookId) {
  await db.collection("reservations").doc(resId).update({
    status: "Returned",
    returnedAt: firebase.firestore.FieldValue.serverTimestamp()
  });

  await db.collection("books").doc(bookId).update({
    availableCopies: firebase.firestore.FieldValue.increment(1)
  });

  alert("Book returned successfully");
}
</script>
</body>
</html>